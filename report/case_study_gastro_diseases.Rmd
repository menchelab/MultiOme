# Interpretation of differential modularity

A case study of microscopic analysis using our multiple networks framework. We explore the differential modularity of gastroenterological diseases as an example.


```{r computing specific info}

# load cached networks and diseases and LCC results
source("../source/cache_all_networks_and_disease_genes.R")

pacman::p_load(treemap, igraph, tidygraph, ggraph)

disease_of_interest <- "Rare genetic gastroenterological disease" 


# unique disease set under the term
individual_gene_set <- individual_diseases_genes %>% dplyr::filter(grepl(disease_of_interest, roots))

# all genes associated
genes_set <- rare_genetic_diseases_genes$disgene_list[[disease_of_interest]]

# list of all significant networks 
signif_nets <- processed_result_df %>% dplyr::filter(name == disease_of_interest, LCC.signif != "none") %>% arrange(desc(LCC.zscore)) %>% pull(network)

# degrees each gene in each network
degree_diseasegenes <- sapply(g[signif_nets], function(x) degree(x, v = intersect(V(x)$name, genes_set)))


# igraph object of significant networks for the disease group
disease_graph <- lapply(signif_nets, function(x) g[[x]]- setdiff(V(g[[x]])$name, genes_set))
names(disease_graph) <- signif_nets

```

## Individual disease gene association 

There are `r `nrow(individual_gene_set)` individual disease terms under `r disease_of_interest`, involving `r length(genes_set)` genes.

```{r}
# print the paged table
individual_gene_set %>% 
  select(label, genes, n_genes) %>% 
  arrange(-n_genes) %>%
  rmarkdown::paged_table()
```

The tree map for descendants of `r disease_of_interest` are as follows (limited to terms with at least two associated genes).
```{r treemap}

# set a threshold for minimal amount of genes required to include in the plotting
threshold = 2

individual_gene_set_wrap <- individual_gene_set %>% dplyr::filter(n_genes >= threshold) %>% select(label, n_genes)

n_removed <- sum(individual_gene_set$n_genes<=threshold)
#individual_gene_set_wrap <- rbind(individual_gene_set_wrap, data.frame(label = sprintf("Other (%i diseases with one or two associated genes)", n_removed), n_genes = n_removed))


# Create data
{group <- ifelse(individual_gene_set_wrap$n_genes > threshold+2, 
                individual_gene_set_wrap$label, str_trunc(individual_gene_set_wrap$label, 50, side = "right"))

value <- individual_gene_set_wrap$n_genes
data <- data.frame(group,value)
 

treemap(data,
        palette = "Set3",   
        title = disease_of_interest,
            index="group",
            vSize="value",
            type="index"
            )
}

# treemap - uncomment to plot
#pdf("../Figs/treemap_gastroenterological.pdf", width = 5, height = 4)
```


The module significance computation shows the following networks being significant:

```{r}
processed_result_df %>% 
  dplyr::filter(name == disease_of_interest, LCC.signif != "none") %>% 
  arrange(desc(LCC.zscore)) %>%
  select(subtype, main_type, N_in_graph, LCC.size, LCC.mean, LCC.sd, LCC.zscore, correctedPval) %>%
  knitr::kable()
```

The network differential modularity can be visualised as follows:

# 
```{r}
    # convert the igraph object into df for ggraph visualisation
disease_graph_df <- lapply(disease_graph, as_data_frame) %>% 
  bind_rows(., .id = "network") %>% 
  mutate(network = factor(network, levels = signif_nets))
    
    
disease_tidygraph <- as_tbl_graph(disease_graph_df) %>% 
  mutate(degree = centrality_degree(mode = 'all'))
    
tidygraph_ggrpah <- ggraph(disease_tidygraph, layout = 'kk')

 p <- tidygraph_ggrpah + 
          geom_edge_density(aes(fill = network),
                            show.legend = FALSE) + 
          geom_edge_fan(aes(alpha = stat(index), 
                            col = network), 
                          show.legend = FALSE) + 
          geom_node_point(col = "white",
                          alpha = 0.25,
                           show.legend  = F, 
                           size = 1) + 
          facet_edges(~factor(network, levels = signif_nets)) + 
          # black theme
            theme_graph(fg_text_colour = 'white', 
                      background = "black",
                      text_colour = "white") 
 
# uncomment when need to replot and save
#ggsave2(sprintf("../Figs/networks_%s.pdf", disease_of_interest), plot = p, width = 10, height = 6)
#ggsave2(sprintf("../Figs/networks_%s_separate_dimmed.png", disease_of_interest), plot = p, width = 10, height = 6) 

p
```

```{r}
pacman::p_load(ggiraph)


disease_tidygraph_ppi <- as_tbl_graph(disease_graph_df %>% filter(network == "ppi")) %>% 
  mutate(degree = centrality_degree(mode = 'all')) 
 

p <- ggraph(disease_tidygraph_ppi, layout = 'kk') + 
          geom_edge_density(aes(fill = network),
                            show.legend = FALSE) + 
         geom_edge_fan(aes(alpha = stat(index), 
                            col = network), 
                          show.legend = FALSE) + 
     #     geom_node_point(col = "white",
    #                      alpha = 0.25,
     #                      show.legend  = F, 
      #                     size = 1) + 
        geom_point_interactive(col = "white", alpha = 0.25, size = 1,
                  mapping = aes(x = x, y = y, #data_id = gender,
                                tooltip = name))+
         # facet_edges(~factor(network, levels = signif_nets)) + 
          # black theme
            theme_graph(fg_text_colour = 'white', 
                      background = "black",
                      text_colour = "white") 

ggiraph(ggobj = p) 
```


## Enrichment of differential modularity

```{r}
LCC_genes_extract <- function(graph){
  comps <- components(graph)
  all_genes <- comps$membership
  LCC_genes <- names(all_genes[all_genes == which.max(comps$csize)])
  return(LCC_genes)
}

LCC_genes <- sapply(signif_nets, function(x) LCC_genes_extract(disease_graph[[x]]))


intersect(LCC_genes$ppi, LCC_genes$reactome_copathway)

# enrichment

pacman::p_load(enrichR)

enrichresults <- list()
enrichresults$ppi <- enrichr(LCC_genes$ppi, databases = "CORUM")
enrichresults$HP <- enrichr(LCC_genes$HP, databases = "Human_Phenotype_Ontology")
enrichresults$coex_EMC <- enrichr(LCC_genes$coex_EMC, databases = "Human_Phenotype_Ontology")
enrichresults$reactome_copathway <- enrichr(LCC_genes$reactome_copathway, databases = "Reactome_2016")
enrichresults$`co-essential` <- enrichr(LCC_genes$`co-essential`, databases = "DepMap_WG_CRISPR_Screens_Broad_CellLines_2019")
```

# NPHP4 connectivity to BBS genes
```{r}
BBS_genes <- individual_gene_set %>% 
  filter(orphaID=="Orphanet:110") %>% 
  pull(genes) %>% 
  str_split(., ";") %>%
  unlist

NPHP_genes <- c("NPHP1", "INVS", "NPHP3", "NPHP4", "IQCB1", "CEP290", "GLIS2", "RPGRIP1L", "NEK8", "SDCCAG8")

NPHP_and_BBS_gene <- intersect(NPHP_genes, BBS_genes)
NPHP_not_BBS_gene <- setdiff(NPHP_genes, BBS_genes)

NPHP4_neightbours <- lapply(signif_nets, function(x) g[[x]]- setdiff(V(g[[x]])$name, c(BBS_genes,NPHP_genes)))
names(NPHP4_neightbours) <- signif_nets

NPHP4_neightbours_df <- lapply(NPHP4_neightbours, as_data_frame) %>% 
  bind_rows(., .id = "network") %>% 
  filter( from %in% NPHP_not_BBS_gene | to  %in% NPHP_not_BBS_gene) %>%
  mutate(network = factor(network, levels = signif_nets))


occurences <- NPHP4_neightbours_df %>%
  pivot_longer(., cols = c("from", "to"), values_to = "gene")
```


```{r network plot - white background, eval=FALSE, include=FALSE}

# white background - not include in the plot

p <- tidygraph_ggrpah + 
  geom_edge_density(aes(fill = network),
                    show.legend = FALSE) + 
  geom_edge_fan(aes(alpha = stat(index), 
                    col = network), 
                  show.legend = FALSE) + 
  geom_node_point(col = "grey50",
                  alpha = 0.25,
                   show.legend  = F, 
                   size = 0.75) + 
  facet_edges(~factor(network, levels = signif_nets)) + 
  theme_graph(fg_text_colour = 'black', 
              background = "white",
              text_colour = "black") 

p

ggsave2(sprintf("../Figs/networks_%s_separate_white_bg.png", disease_of_interest), plot = p, width = 10, height = 6) 
```




```{r plot the entire module, eval=FALSE, include=FALSE}
# Prioritise networks with smallest LCC

disease_graph_df_collapse <- disease_graph_df %>% 
  group_by(from, to) %>% summarise(networks = list(network)) %>% 
  rowwise() %>% 
  mutate(n_network = length(networks), 
         displaytype = signif_nets[min(which(signif_nets %in% networks))])

# graph to be displayed
graph_disp <- disease_graph_df_collapse %>% as_tbl_graph() %>% 
    mutate(degree = centrality_degree(mode = 'all'))


graph_disp_ggraph <- ggraph(graph_disp, layout = 'kk')


# assign a disease label to each gene
# a dictionary linking gene to representative disease names
individual_gene_list <- individual_gene_set %>%
arrange(desc(n_genes)) %>%
mutate(genes = str_split(genes, ";"),
new_label = ifelse(n_genes > 4, label, "Other")) %>%
select(genes, new_label) %>%
unnest(genes) %>%
distinct(genes, .keep_all = T) %>%
deframe()

p <- graph_disp_ggraph +
    geom_edge_fan(aes(alpha = stat(index),col = "white"), show.legend = F) +
    geom_node_point(aes(size = degree,
                        col = individual_gene_list[name]),# col = "white", 
                    show.legend  = T) + 
    theme_graph(foreground = 'black', fg_text_colour = 'white', background = "black",
                text_colour = "white") +
    scale_color_brewer(type = "seq", palette = "PuBu", direction = -1) +
  scale_edge_color_manual(values = "#ffffb2") +
  guides(size = F, degree = F, edge_colour = F, node_size = F)


# uncomment this when need to resave the plot
#ggsave2(sprintf("../Figs/network_combined_%s_node_labels.pdf", disease_of_interest), p, width = 12, height = 6)

p
```




```{r, eval=FALSE, include=FALSE}
# perform community detection

graph_community <- disease_graph_df_collapse %>% 
  dplyr::filter("coex_EMC" %in% networks) %>%
  as_tbl_graph(directed = F) %>% 
  activate(nodes) %>%
    mutate(degree = centrality_degree(mode = 'all'),
      community = as.factor(group_louvain()))

graph_community_gg <- ggraph(graph_community,layout = 'kk')

p <- graph_community_gg +
    geom_edge_fan(aes(col = "white")) +
    geom_node_point(aes(size = degree, col = community),
                    show.legend  = T) + 
    theme_graph(foreground = 'black', fg_text_colour = 'white', background = "black",
                text_colour = "white") +
   # scale_color_brewer(type = "seq", palette = "Blues", direction = -1) +
  scale_edge_color_manual(values = "white") 

p
```


