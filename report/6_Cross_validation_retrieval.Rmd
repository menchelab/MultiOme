# Modularity as quantification of pathobiological relevance

Note: this was the old version and the indexed one sohuld be replaced by the new one.

```{r load data}
pacman::p_load(patchwork, cowplot, ggstatsplot)
knitr::opts_chunk$set(echo=FALSE)

AUC_folds_file <- "../cache/fold_cv_processed_results.RDS"
if(!file.exists(AUC_folds_file)){
  source("../source/process_fold_cv_results.R")
}
palettes <- c('#fc8d62','#66c2a5','#8da0cb')

AUC_folds_summary <- readRDS(AUC_folds_file)
```

## ROC-AUC comparison among all diseases and and network selection (Fig. 5b)
```{r}
p <- ggplot(AUC_folds_summary,aes(x=name_short, fill = label, group = label)) +
   geom_ribbon(aes(ymin = Q25, ymax = Q75), alpha = 0.25) +
  geom_line(aes(y = med, col = label), linetype = 2) +
  coord_flip() + xlab("disease") + ylab("fold AUC") + theme_minimal_hgrid() + theme(legend.position = "bottom") +
  ggtitle("ROC-AUC comparison", subtitle = "area spans 25, 50 and 75% quantile") +
  scale_fill_manual(values=palettes) + scale_color_manual(values=palettes)
#ggsave("../Figs/cvROC/AUC_folds_comparison_short_names.pdf", p, width = 6, height = 6)

p
```


## Corresponding p-value based on statistical test for avg ROC curve (Fig. 5c)

```{r}
AUC_folds_summary_plot <- tibble(label = AUC_folds_summary$label, 
                                 AUC = AUC_folds_summary$mean)

plot_df = tibble(x = factor(AUC_folds_summary$label,  
                            levels = c(  "PPI only" , "all networks"  , "significant networks"),
                            labels = c(  "PPI only" , "All networks"  , "Significant networks")), y = AUC_folds_summary$mean)

barstatplot <- ggstatsplot::ggwithinstats(data = plot_df,
              x = x, y = y,type = "np") + 
  xlab("Method") + ylab("AUC") +
  scale_color_manual(values = palettes) #+ylim(0.6, 1)
  

#ggsave(plot = barstatplot, filename = "../Figs/10fold_cv_method_compared_boxplot.pdf", width = 6*0.8, height = 4*0.8)

barstatplot
```



## relationship between the disease, number of signifiant networks, and number of genes (Fig. 5d)


```{r}
## load the LCC results 
source("../source/cache_all_networks_and_disease_genes.R")
## count number of networks, only coex

N_signif_net = processed_result_df_plot %>% 
  filter(type=="Co-expression") %>%
  count(name, name_short, name = "significant_tissues")


## load the gene sets
Orphanet_df <-rare_genetic_diseases_genes$disgene_df %>% select(name, N)

Orphanet_df <- left_join(Orphanet_df, N_signif_net)

# retrieve median values
AUC_folds_perf_compare <- AUC_folds_summary_updated_plot %>% 
  pivot_wider(., id_cols = name, names_from = label, values_from = med) %>%
  mutate(dif = `Significant layers` - `All layers`) %>%
  rename(name_short = "name") %>%
  left_join(x=., y = Orphanet_df) #, by = c(name = "name_short"))

AUC_allnets_median <- AUC_folds_summary_updated_plot %>% 
    rename(name_short = "name") %>%
  dplyr::select(-Q25, -Q75) %>%
  dplyr::filter(label == 'Significant layers') %>%
  left_join(x=., y = Orphanet_df)


p1 <- ggplot(AUC_folds_perf_compare %>%
               ungroup %>%
               mutate(label = ifelse(dif< 0, name_short,""))
             , aes(x = significant_tissues, y = dif)) + 
  geom_point(col = "grey40") + 
  theme_cowplot() + guides(size = F) + 
  geom_hline(yintercept = 0, linetype = "dotted", col = "grey20") + 
 # stat_summary(fun.data= mean_cl_normal) + 
  geom_smooth(method='lm', se = F) +
  xlab("# Significant tissues") + ylab(expression("Performance diff. ("*Delta*"AUC)"))

p2 <- ggplot(AUC_allnets_median, aes(x = N, y = med)) + geom_point(col = "grey40") + theme_cowplot() + 
  guides(size = F) + xlab("# Associated genes") + ylab("Median AUC") + 
  scale_x_log10() +
   geom_smooth(method='lm', se = F)   



p <- p1 + p2

#ggsave(filename = "../Figs/scatter_AUC_vs_ntissues_updated.pdf",plot = p,  height = 3, width = 6)

p
```
### Corresponding statistical parameters on the left plot (Performance difference vs #tissue):

```{r}
cor.test(AUC_folds_perf_compare$dif,AUC_folds_perf_compare$significant_tissues, method = "spearman")
```

### Corresponding statistical parameters on the right plot (Performance vs #genes):
```{r}
cor.test(AUC_allnets_median$N, AUC_allnets_median$med, method = "spearman")
```

## Performance difference: using relevant networks vs all networks (Suppl. Fig. 5b)


```{r}
p <- AUC_folds_perf_compare %>%
  left_join(., distinct(AUC_folds_summary, name) %>% rename(name_short = "name"), by="name_short") %>%
  ungroup %>% 
  mutate(name_short = fct_reorder(name_short, significant_tissues)) %>%
  ggplot(., aes(x = name_short, y = significant_tissues, fill=dif)) + geom_col() + theme_minimal() + coord_flip() + 
  scale_fill_gradient2(low = "#66c2a5", high = "#8da0cb") + 
  ylab("# Significant tissues") + xlab("") + labs(fill = "")+ ggtitle("Performance difference", subtitle = "Selected networks vs all networks")

#ggsave("../Figs/barchart_n_tissues_vs_performance_difference.pdf", height = 4, width = 6)

p
```




