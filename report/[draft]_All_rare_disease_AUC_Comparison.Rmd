# Modularity as quantification of pathobiological relevance


```{r load data}
pacman::p_load(patchwork, cowplot, ggstatsplot)
knitr::opts_chunk$set(echo=FALSE)

#AUC_folds_file <- "../cache/fold_cv_processed_results_revision.RDS"

#if(!file.exists(AUC_folds_file)){
#  source("../source/process_fold_cv_results.R")
#}

AUC_folds_summary <- readRDS("../cache/fold_cv_processed_results.RDS") %>% filter(label!="all networks")


# compute median and 25% and 75% quantile
AUC_folds_revision <- readRDS("../cache/fold_cv_processed_results_revision.RDS") 
  
AUC_folds_revision <- AUC_folds_revision %>% 
  group_by(name, label) %>% 
  summarise(mean = mean(AUC), med = median(AUC), Q25 = quantile(AUC, 0.25), Q75 = quantile(AUC, 0.75)) #%>%
#  mutate(name_short = factor(name, levels = levels(name), labels = short_names))


AUC_folds_summary_plot <- rbind(AUC_folds_summary %>% select(-name_short), AUC_folds_revision)

# reorder based on performance
order_performance <- AUC_folds_summary_plot %>% filter(label == "all") %>% arrange(mean) %>% pull(name)

AUC_folds_summary_plot <- AUC_folds_summary_plot %>%
  mutate(short_names = factor(name, levels = order_performance),
         label = factor(label, levels = c("all", "Largescale_signif", "significant networks", rev(c("PPI only", "PPI_curated", "PPI_largescale"))), labels = c("All networks", "Disease significant (large scale)", "Disease significant ", rev(c("PPI", "PPI (curated)", "PPI (largescale)")))))

library(RColorBrewer)

palettes <- c(brewer.pal(3, "Blues"), brewer.pal(3, "Greens"))  
```

## ROC-AUC comparison among all diseases and and network selection (Fig. 5b)
```{r}
p <- ggplot(AUC_folds_summary_plot,aes(x=short_names, fill = label, group = label)) +
   geom_ribbon(aes(ymin = Q25, ymax = Q75), alpha = 0.25) +
  geom_line(aes(y = med, col = label), linetype = 2) +
  coord_flip() + xlab("disease") + ylab("fold AUC") + theme_minimal_hgrid() + theme(legend.position = "bottom") +
  ggtitle("ROC-AUC comparison", subtitle = "area spans 25, 50 and 75% quantile") +
  #scale_fill_brewer(type = "qual") + scale_color_brewer(type = "qual")
  scale_fill_manual(values=palettes) + scale_color_manual(values=palettes)
#ggsave("../Figs/cvROC/AUC_folds_comparison_short_names.pdf", p, width = 6, height = 6)

p
```

```{r}
AUC_folds_summary_plot <- AUC_folds_summary_plot %>%
  mutate(network_group = ifelse(grepl("ppi", label, ignore.case = T), "PPI only", "Multiplex"))

         
p <- ggplot(AUC_folds_summary_plot,aes(x=short_names, fill = label, group = label)) +
   geom_ribbon(aes(ymin = Q25, ymax = Q75), alpha = 0.25) +
  geom_line(aes(y = med, col = label), linetype = 2) +
  facet_grid(.~ network_group) +
  coord_flip() + xlab("disease") + ylab("fold AUC") + theme_minimal_hgrid() + theme(legend.position = "bottom") +
  ggtitle("ROC-AUC comparison", subtitle = "area spans 25, 50 and 75% quantile") +
  #scale_fill_brewer(type = "qual") + scale_color_brewer(type = "qual")
  scale_fill_manual(values=palettes) + scale_color_manual(values=palettes)
#ggsave("../Figs/cvROC/AUC_folds_comparison_short_names.pdf", p, width = 6, height = 6)

p
```


## Corresponding p-value based on statistical test for avg ROC curve (Fig. 5c)

```{r}
AUC_folds_summary_plot <- tibble(label = AUC_folds_summary$label, 
                                 AUC = AUC_folds_summary$mean)

plot_df = tibble(x = factor(AUC_folds_summary$label,  
                            levels = c(  "PPI only" , "all networks"  , "significant networks"),
                            labels = c(  "PPI only" , "All networks"  , "Significant networks")), y = AUC_folds_summary$mean)

barstatplot <- ggstatsplot::ggwithinstats(data = plot_df,
              x = x, y = y,type = "np") + 
  xlab("Method") + ylab("AUC") +
  scale_color_manual(values = palettes) #+ylim(0.6, 1)
  

#ggsave(plot = barstatplot, filename = "../Figs/10fold_cv_method_compared_boxplot.pdf", width = 6*0.8, height = 4*0.8)

barstatplot
```



## relationship between the disease, number of signifiant networks, and number of genes (Fig. 5d)


```{r}
## load the LCC results 
result_folder<-"../cache/output/Orphageneset_rare/"
result_df<-readRDS(paste0(result_folder, "LCC_and_distance_calculation_results.RDS"))

source("../functions/process_LCC_result.R")
result_df<-process_LCC_result(result_df, network_annotate=F)

## count number of networks, only coex

n_signif_df<-result_df %>% dplyr::filter(LCC.signif != "none", grepl("coex", network)) %>% group_by(name)  %>% count(name)

## load the gene sets
source("../functions/readdata_functions.R")
Orphanet_df<-process_disease_genes_data("../data/table_disease_gene_assoc_orphanet_genetic.tsv", min_gene=20, max_gene=2000)
Orphanet_n_gene_df<-Orphanet_df$disgene_df

# retrieve median values
AUC_folds_perf_compare <- AUC_folds_summary %>% 
  pivot_wider(., id_cols = name, names_from = label, values_from = med) %>%
  mutate(dif = `significant networks` - `all networks`) %>%
  left_join(x=., y = n_signif_df) %>%
  left_join(x=., y = Orphanet_n_gene_df[,c("name","N")])



AUC_allnets_median <- AUC_folds_summary %>% 
  dplyr::select(-Q25, -Q75, -name_short) %>%
  dplyr::filter(label == 'significant networks') %>%
  left_join(x=., y = n_signif_df) %>%
  left_join(x=., y = Orphanet_n_gene_df[,c("name","N")])


p1 <- ggplot(AUC_folds_perf_compare %>% mutate(label = ifelse(dif< 0, name,"")), aes(x = n, y = dif)) + 
  geom_point(col = "grey40") + 
  theme_cowplot() + guides(size = F) + geom_hline(yintercept = 0, linetype = "dotted", col = "grey20") + 
 # stat_summary(fun.data= mean_cl_normal) + 
  geom_smooth(method='lm', se = F) +
  xlab("# Significant tissues") + ylab(expression("Performance diff. ("*Delta*"AUC)"))

p2 <- ggplot(AUC_allnets_median, aes(x = N, y = med)) + geom_point(col = "grey40") + theme_cowplot() + 
  guides(size = F) + xlab("# Associated genes") + ylab("Median AUC") + 
  scale_x_log10() +
   geom_smooth(method='lm', se = F)   



p <- p1 + p2

#ggsave(filename = "../Figs/scatter_AUC_vs_ntissues.pdf",plot = p,  height = 3, width = 6)

p
```
### Corresponding statistical parameters on the left plot (Performance difference vs #tissue):

```{r}
cor.test(AUC_folds_perf_compare$dif,AUC_folds_perf_compare$n, method = "spearman")
```

### Corresponding statistical parameters on the right plot (Performance vs #genes):
```{r}
cor.test(AUC_allnets_median$N, AUC_allnets_median$med, method = "spearman")
```

## Performance difference: using relevant networks vs all networks (Suppl. Fig. 5b)


```{r}
p <- AUC_folds_perf_compare %>%
  left_join(., distinct(AUC_folds_summary, name, name_short), by="name") %>%
  ungroup %>% 
  mutate(name_short = fct_reorder(name_short, n)) %>%
  ggplot(., aes(x = name_short, y = n, fill=dif)) + geom_col() + theme_minimal() + coord_flip() + scale_fill_gradient2() + ylab("# Significant tissues") + xlab("") + 
  labs(fill = "")+ ggtitle("Performance difference", subtitle = "Selected networks vs all networks")

#ggsave("../Figs/barchart_n_tissues_vs_performance_difference.pdf", height = 4, width = 6)

p
```


# Add results when excluding layers

```{r compare performance upon network layer removal}
AUC_folds_exclude <- readRDS("../cache/fold_cv_processed_results_revision_excludes.RDS") %>%
  # results from Signif
  rbind(., readRDS("../cache/fold_cv_processed_results_revision_Signifs.RDS") ) %>%
  filter(!label %in% c("Signif_withoutPhenotype")) %>%
  # results from GOBP,GOMF,HP,MP
  rbind(., readRDS("../cache/fold_cv_processed_results_revision_excludesOntology_merged.RDS") %>%  filter(!label %in% c("Signif_withoutGO"))) 
  #rbind(., readRDS("../cache/fold_cv_processed_results_revision_excludesOntology_single.RDS") ) 


AUC_folds_exclude <- AUC_folds_exclude %>% 
  group_by(name, label) %>% 
  summarise(mean = mean(AUC), med = median(AUC), Q25 = quantile(AUC, 0.25), Q75 = quantile(AUC, 0.75)) #%>%

#AUC_folds_exclude_plot <- rbind(AUC_folds_exclude,
#                                AUC_folds_revision %>% dplyr::filter(label %in% c("signif_withCoexCore", "Largescale_signif_weighted", "Largescale_signif", "coex_Signif", "coex_core")))

AUC_folds_exclude_plot <- rbind(AUC_folds_exclude,
                                AUC_folds_revision)

AUC_folds_exclude_plot <- AUC_folds_exclude_plot %>%
  mutate(excluded_layer = str_remove(label, "Signif_without"),
         type = ifelse(str_starts(label, "Signif_"), "Significant networks" , ifelse(grepl("ppi", label,ignore.case = T) , "PPIs", "Others"))
         ) 


AUC_folds_Signifs <- AUC_folds_exclude_plot %>% 
  filter(type == "Significant networks") 

order_network <- AUC_folds_Signifs %>% group_by(excluded_layer) %>% summarise(median = median(med)) %>% arrange(median) %>% pull(excluded_layer) %>% as.character() %>% rev()


AUC_folds_Signifs <- AUC_folds_Signifs %>%
  filter(excluded_layer %in% order_network) %>%
  mutate(excluded_layer = fct_relevel(excluded_layer, order_network),
         excluded_layer = recode_factor(excluded_layer, "All Significant layers" = "Signif_all"),
         excluded_layer = fct_relevel(excluded_layer, "All Significant layers"),
        excluded_layer = fct_relevel(excluded_layer, "LargeScaleNet", after = Inf))


order_network <- AUC_folds_exclude_plot %>% group_by(excluded_layer) %>% summarise(median = median(med)) %>% arrange(median) %>% pull(excluded_layer)

AUC_folds_exclude_plot$excluded_layer <- factor(AUC_folds_exclude_plot$excluded_layer, levels = order_network)

#ggplot(AUC_folds_Signifs, aes(x=excluded_layer, y=med)) + geom_boxplot() + theme_cowplot() 



p_compare_all_nets <- ggwithinstats(
  data = AUC_folds_Signifs %>% filter(!excluded_layer %in% c("CoEx", "CoEsssential", "PPI")) %>% ungroup,
  x = excluded_layer,
  y = med,
  p.adjust.method = "BH",
 title = "AUC values upon removing layers",
#  caption = "Data source: `WRS2` R package",
  ggtheme = theme_cowplot(), 
  xlab = "Excluded layer",
  ylab = "10-fold CV median AUC", 
  sample.size.label = F,
#ggplot.component = list(scale_color_brewer(palette = "Blues"), scale_fill_brewer(palette = "Blues")),
type = "non-parametric"#, 
#ggplot.component = c(col = "grey")
#  ggtheme = ggthemes::theme_fivethirtyeight()
)


ggsave("../Figs/compare_CuratedNetwork_removal_AUC.pdf", p_compare_all_nets, height = 4, width =6, scale = 1.125)

p_compare_all_nets
```


```{r compare each of the pair separately}

# networks_to_consider <- AUC_folds_Signifs %>% filter(!excluded_layer %in% c("CoEx", "CoEsssential")) %>% pull(excluded_layer) %>% unique
# 
# for(i in 1:(length(networks_to_consider)-1)){
#   for(j in (i+1):length(networks_to_consider)){
#     p <- ggwithinstats(
#   data = dplyr::filter(
#     AUC_folds_Signifs,
#     excluded_layer %in% networks_to_consider[c(i,j)]
#   ),
#   x = excluded_layer,
#   y = med,
#   type = "np", # non-parametric statistics
#   ggtheme = theme_cowplot(), 
#   xlab = "Excluded layer",
#   ylab = "10-fold CV median AUC", 
#   sample.size.label = F,
#   grouping.var = excluded_layer
# )
#     ggsave(paste0("../Figs/RemovingLayers/compare_CuratedNetwork_removal_AUC_",i,"_",j,".pdf"), p, height = 4, width =2, scale = 1.125)
#   }
# }

dat <- AUC_folds_Signifs %>% filter(excluded_layer %in% c("LargeScaleNet", "Signif_all")) %>%
  select(excluded_layer, med, name) %>%
  pivot_wider(names_from = excluded_layer, values_from = med) 

p <- ggplot(dat, aes(x = Signif_all, y = LargeScaleNet, label = name)) + geom_point() + geom_abline(intercept = 0, slope = 1, col ="red")
plotly::ggplotly(p)

```


```{r compare PPI}
AUC_folds_PPI <-  rbind(AUC_folds_exclude_plot %>% filter(type == "PPIs") %>% select(colnames(.)[1:6] ),
                        AUC_folds_summary[1:6] %>% filter(label == "PPI only")) %>% ungroup %>%
  mutate(label = factor(label, levels = c("PPI only", "PPI_curated", "PPI_largescale"), 
                        labels = c("Full", "Curated", "Large scale")),
         label_plot = (label))



p_compare_PPI <- ggwithinstats(
  data = AUC_folds_PPI,# %>% filter(!excluded_layer %in% c("CoEx", "CoEssential")) %>% ungroup,
  x = label_plot,
  y = med,
  p.adjust.method = "BH",
  title = "AUC values upon removing layers",
#  caption = "Data source: `WRS2` R package",
  ggtheme = theme_cowplot(), 
  xlab = "PPI set",
  ylab = "10-fold CV median AUC", 
#ggplot.component = list(scale_color_brewer(palette = "Blues"), scale_fill_brewer(palette = "Blues")),
type = "non-parametric"#, 
#ggplot.component = c(col = "grey")
#  ggtheme = ggthemes::theme_fivethirtyeight()
)


#ggsave("../Figs/compare_PPI_network_removal_AUC.pdf", p_compare_PPI, height = 4, width =3, scale = 1.125)

p_compare_PPI
```

## Compare single most significant layer, signif, and all layers

```{r}
# Single Signif Layer
AUC_folds_singleSignif <- readRDS("../cache/fold_cv_processed_results_revision_singleMostSignifLayer.RDS")

#AUC_folds_singleSignif <- AUC_folds_singleSignif %>% 
#  group_by(name, label) %>% 
#  summarise(mean = mean(AUC), med = median(AUC), Q25 = quantile(AUC, 0.25), Q75 = quantile(AUC, 0.75))
  
network_used <- AUC_folds_singleSignif %>% select(name, label) %>% distinct()

AUC_folds_singleSignif$label = "SingleMostSignif"


# Significant layers (update those with coex)

# compute median and 25% and 75% quantile
AUC_folds_signif_updated <- readRDS("../cache/fold_cv_processed_results_revision.RDS") %>% filter(label %in% c("all", "signif_withCoexCore")) %>%
  mutate(label = factor(label,levels = c("all", "signif_withCoexCore"), labels = c("All layers", "Significant layers")))

disease_withUpdatedData <- AUC_folds_signif_updated %>% filter(label == "Significant layers") %>% pull(name) %>% unique
  
# the signif network inly computed for those that coex_core does not change   
AUC_folds_signif_orig <- readRDS("../cache/fold_cv_processed_results.RDS") %>% filter((label=="significant networks" & !name %in% disease_withUpdatedData) | label == "PPI only") %>%
  mutate(label = factor(label, levels = c("significant networks", "PPI only"), labels = c("Significant layers", "PPI"))) %>% select(-name_short)


AUC_folds_summary_updated <- rbind(AUC_folds_signif_updated, AUC_folds_singleSignif) %>% 
  group_by(name, label) %>% 
  summarise(mean = mean(AUC), med = median(AUC), Q25 = quantile(AUC, 0.25), Q75 = quantile(AUC, 0.75)) #%>%
#  mutate(name_short = factor(name, levels = levels(name), labels = short_names))

AUC_folds_summary_updated <- rbind(AUC_folds_summary_updated,AUC_folds_signif_orig)

# reorder based on performance
order_performance <- AUC_folds_summary_updated %>% filter(label == "Significant layers") %>% arrange(mean) %>% pull(name)


AUC_folds_summary_updated_plot <- AUC_folds_summary_updated %>%
  mutate(name = factor(name, levels = order_performance),
         name = fct_recode(name, `Rare genetic gynecological diseases`="Rare genetic gynecological and obstetrical diseases", 
                           `Rare genetic developmental defect..`="Rare genetic developmental defect during embryogenesis",
                           `Rare genetic rheumatologic disease`="Rare genetic systemic or rheumatologic disease"))


palettes <- c('#66c2a5','#8da0cb',"#fec44f" , '#fc8d62')

p <- ggplot(AUC_folds_summary_updated_plot,aes(x=name, fill = label, group = label)) +
   geom_ribbon(aes(ymin = Q25, ymax = Q75), alpha = 0.25) +
  geom_line(aes(y = med, col = label), linetype = 2) +
  coord_flip() + xlab("disease") + ylab("fold AUC") + theme_minimal_hgrid() + theme(legend.position = "bottom") +
  ggtitle("ROC-AUC comparison", subtitle = "area spans 25, 50 and 75% quantile") +
  #scale_fill_brewer(type = "qual") + scale_color_brewer(type = "qual")
  scale_fill_manual(values=palettes) + scale_color_manual(values=palettes)

#ggsave("../Figs/AUC_folds_comparison_short_names_updated.pdf", p, width = 6, height = 6)

p
```
## The equivalent boxplot

```{r}
AUC_folds_summary_updated_plot2 <- AUC_folds_summary_updated_plot %>%
  mutate(label_plot = fct_recode(label, `Single most\n relevant layer`="SingleMostSignif"),
         label_plot = fct_relevel(label_plot, "All layers", after = 1))

palettes2 <- c('#8da0cb','#66c2a5',"#fec44f" , '#fc8d62')

p_compare_main <- ggwithinstats(
  data = AUC_folds_summary_updated_plot2,# %>% filter(!excluded_layer %in% c("CoEx", "CoEssential")) %>% ungroup,
  x = label_plot,
  y = med,
  p.adjust.method = "fdr",
  #title = "AUC values",
#  caption = "Data source: `WRS2` R package",
  ggtheme = theme_cowplot(), 
  xlab = "Network layers",
sample.size.label = F,
pairwise.display = "significant",
  ylab = "AUC", 
#ggplot.component = list(scale_color_brewer(palette = "Blues"), scale_fill_brewer(palette = "Blues")),
type = "non-parametric"#, 
#ggplot.component = c(col = "grey")
#  ggtheme = ggthemes::theme_fivethirtyeight()
) + scale_color_manual(values = palettes2)

ggsave(plot = p_compare_main, filename = "../Figs/10fold_cv_method_compared_boxplot_updated.pdf", width = 6.5, height = 4, scale = 0.9)

p_compare_main
```



## relationship between the disease, number of signifiant networks, and number of genes (Fig. 5d)


```{r}
## load the LCC results 
source("../source/cache_all_networks_and_disease_genes.R")
## count number of networks, only coex

N_signif_net = processed_result_df_plot %>% 
  filter(type=="Co-expression") %>%
  count(name, name_short, name = "significant_tissues")


## load the gene sets
Orphanet_df <-rare_genetic_diseases_genes$disgene_df %>% select(name, N)

Orphanet_df <- left_join(Orphanet_df, N_signif_net)

# retrieve median values
AUC_folds_perf_compare <- AUC_folds_summary_updated_plot %>% 
  pivot_wider(., id_cols = name, names_from = label, values_from = med) %>%
  mutate(dif = `Significant layers` - `All layers`) %>%
  rename(name_short = "name") %>%
  left_join(x=., y = Orphanet_df) #, by = c(name = "name_short"))

AUC_allnets_median <- AUC_folds_summary_updated_plot %>% 
    rename(name_short = "name") %>%
  dplyr::select(-Q25, -Q75) %>%
  dplyr::filter(label == 'Significant layers') %>%
  left_join(x=., y = Orphanet_df)


p1 <- ggplot(AUC_folds_perf_compare %>%
               ungroup %>%
               mutate(label = ifelse(dif< 0, name_short,""))
             , aes(x = significant_tissues, y = dif)) + 
  geom_point(col = "grey40") + 
  theme_cowplot() + guides(size = F) + 
  geom_hline(yintercept = 0, linetype = "dotted", col = "grey20") + 
 # stat_summary(fun.data= mean_cl_normal) + 
  geom_smooth(method='lm', se = F) +
  xlab("# Significant tissues") + ylab(expression("Performance diff. ("*Delta*"AUC)"))

p2 <- ggplot(AUC_allnets_median, aes(x = N, y = med)) + geom_point(col = "grey40") + theme_cowplot() + 
  guides(size = F) + xlab("# Associated genes") + ylab("Median AUC") + 
  scale_x_log10() +
   geom_smooth(method='lm', se = F)   



p <- p1 + p2

#ggsave(filename = "../Figs/scatter_AUC_vs_ntissues_updated.pdf",plot = p,  height = 3, width = 6)

p
```
### Corresponding statistical parameters on the left plot (Performance difference vs #tissue):

```{r}
cor.test(AUC_folds_perf_compare$dif,AUC_folds_perf_compare$significant_tissues, method = "spearman")
```

### Corresponding statistical parameters on the right plot (Performance vs #genes):
```{r}
cor.test(AUC_allnets_median$N, AUC_allnets_median$med, method = "spearman")
```

## Performance difference: using relevant networks vs all networks (Suppl. Fig. 5b)


```{r}
p <- AUC_folds_perf_compare %>%
  left_join(., distinct(AUC_folds_summary, name) %>% rename(name_short = "name"), by="name_short") %>%
  ungroup %>% 
  mutate(name_short = fct_reorder(name_short, significant_tissues)) %>%
  ggplot(., aes(x = name_short, y = significant_tissues, fill=dif)) + geom_col() + theme_minimal() + coord_flip() + 
  scale_fill_gradient2(low = "#66c2a5", high = "#8da0cb") + 
  ylab("# Significant tissues") + xlab("") + labs(fill = "")+ ggtitle("Performance difference", subtitle = "Selected networks vs all networks")

#ggsave("../Figs/barchart_n_tissues_vs_performance_difference.pdf", height = 4, width = 6)

p
```
