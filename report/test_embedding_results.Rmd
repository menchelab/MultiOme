---
title: 
description: |
  Embedding results for rare genetic diseases
author:
  - name: Pisanu Ize Buphamalai
date: "`r Sys.Date()`"
output: distill::distill_article
---
This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r create coordinates, eval=FALSE}
# only run this chuck to recompute all the coordinate values


#embed_result_dir = "./embedded_results/"
embed_result_dir = "../data/network_node2vec_results//"  #only the new coexpression networks
embed_files = list.files(embed_result_dir, recursive = T)

# dim reduction
library(uwot)
library(Rtsne)

for(i in embed_files){
  print(i)
  df = read_delim(paste0(embed_result_dir, i), delim = " ", skip = 1, col_names = F) 
  df = df[apply(df, 1, function(x) !any(is.na(x))),]
  df = column_to_rownames(df, var = "X1")
  
  print("UMAP")
  umap_results = uwot::umap(df, n_neighbors = 15)
  print("PCA")
  pca_results = pcaMethods::pca(df)
  print("tsne")
  tsne_results = Rtsne::Rtsne(X = df, dims=2)
  
  umap_results_df = tibble(X = umap_results[,1], Y = umap_results[,2])
  tsne_results_df = tibble(X = tsne_results$Y[,1], Y = tsne_results$Y[,2])
  pca_results_df = tibble(X = pca_results@scores[,1], Y = pca_results@scores[,2])
  
  umap_results_df$name = tsne_results_df$name = pca_results_df$name = rownames(df)
  
  write_tsv(umap_results_df, paste("../cache/embedded_results_2D/", i, "umap.tsv", sep = "_"), col_names = T)
  write_tsv(tsne_results_df, paste("../cache/embedded_results_2D/", i, "tsne.tsv", sep = "_"), col_names = T)
  write_tsv(pca_results_df, paste("../cache/embedded_results_2D/", i, "pca.tsv", sep = "_"), col_names = T)
}
```

```{r plot embeded files}
source("../functions/readdata_functions.R")

# folder to add figures
embedding_fig_dir = "../Figs/embedding/"

orpha = process_disease_genes_data("../data/table_disease_gene_assoc_orphanet_genetic.tsv", 20, 2000)

alldiseases = names(orpha$disgene_list)


for(d in alldiseases){
  disease = orpha$disgene_list[[d]]
  
  for(n in embed_files){
    network_name = str_replace(n, "coex/", "")
    
    # load the node2vec embedded results
    tsne_results_df = read_tsv(paste("../cache//embedded_results_2D/", network_name, "tsne.tsv", sep = "_"), col_types = 'ddc') %>% 
      mutate(indisease = name %in% disease)

    n <- str_replace(n, "/", "_") # replace / by _ for labelling
    
    # create directory to store results
    dir.create(file.path(paste0(embedding_fig_dir, "/by_disease"),  d), showWarnings = FALSE)
    dir.create(file.path(paste0(embedding_fig_dir, "/by_network"),  n), showWarnings = FALSE)
 
    
    
    p <- ggplot(tsne_results_df)  + 
      stat_density_2d(aes(X,Y,  fill = stat(level)), geom = "polygon") + 
      theme(panel.background = element_rect(fill = '#0f2030'),
            axis.line=element_blank(),axis.text.x=element_blank(),
            axis.text.y=element_blank(),axis.ticks=element_blank(),
            axis.title.x=element_blank(),
            axis.title.y=element_blank(),legend.position="none",
            panel.border=element_blank(),panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),plot.background=element_blank())+ 
      geom_point(aes(X,Y, alpha = indisease), col = "white", size = 1) +
      scale_alpha_discrete(range = c(0, 0.5)) + guides(fill = FALSE, alpha = FALSE, col = FALSE)+
      ggtitle(paste0(d,": ",n))
    
    ggsave(filename = sprintf("%s/%s/%s/%s.pdf", embedding_fig_dir, "by_disease", d, n), plot = p, device = "pdf", width = 5, height = 5)
    ggsave(filename = sprintf("%s/%s/%s/%s.pdf", embedding_fig_dir, "by_network", n, d), plot = p, device = "pdf", width = 5, height = 5)
           
  }
}

```

## The HP networks 

```{r}

tsne_results_df <- read_tsv("../cache//embedded_results_2D/_HP_tsne.tsv", col_types = 'ddc') 

selected_diseases <- c(
 # "Rare genetic vascular disease",
#  "Rare genetic systemic or rheumatologic disease", 
#"Rare genetic eye disease", "Rare genetic gynecological and obstetrical diseases", 
"Rare genetic immune disease", 
"Rare genetic cardiac disease", 
"Rare genetic renal disease",
#"Rare genetic developmental defect during embryogenesis", 
"Rare genetic bone disease", 
#"Rare genetic odontologic disease", 
"Rare genetic hematologic disease", 
#"Laminopathy", "Ciliopathy", 
#"Genetic otorhinolaryngologic disease", "Rare genetic urogenital disease", 
#"Rare genetic hepatic disease", "Rare genetic endocrine disease", 
"Rare genetic neurological disorder"#,# "RASopathy", "Rare genetic gastroenterological disease", 
#"Rare inborn errors of metabolism", "Genetic infertility", "Rare genetic skin disease", 
#"Rare chromosomal anomaly", "Rare genetic tumor", "Inherited cancer-predisposing syndrome"
)

# custom plot

for(d in alldiseases){
  disease = orpha$disgene_list[[d]]
  
  for(n in c("HP")){
    network_name = str_replace(n, "coex/", "")
    
    # load the node2vec embedded results
    tsne_results_df = read_tsv(paste("../cache//embedded_results_2D/", network_name, "tsne.tsv", sep = "_"), col_types = 'ddc') %>% 
      mutate(indisease = name %in% disease)

    n <- str_replace(n, "/", "_") # replace / by _ for labelling
    
    # create directory to store results
    dir.create(file.path(paste0(embedding_fig_dir, "/by_disease"),  d), showWarnings = FALSE)
    dir.create(file.path(paste0(embedding_fig_dir, "/by_network"),  n), showWarnings = FALSE)
 
    
    
    p <- ggplot(tsne_results_df)  + 
      stat_density_2d(aes(X,Y,  fill = stat(level)), geom = "polygon") + 
      theme(panel.background = element_rect(fill = '#0f2030'),
            axis.line=element_blank(),axis.text.x=element_blank(),
            axis.text.y=element_blank(),axis.ticks=element_blank(),
            axis.title.x=element_blank(),
            axis.title.y=element_blank(),legend.position="none",
            panel.border=element_blank(),panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),plot.background=element_blank())+ 
      geom_point(aes(X,Y, alpha = indisease), col = "white", size = 1) +
      scale_alpha_discrete(range = c(0, 0.5)) + guides(fill = FALSE, alpha = FALSE, col = FALSE)+
      ggtitle(paste0(d,": ",n))
    
   # ggsave(filename = sprintf("%s/%s/%s/%s.pdf", embedding_fig_dir, "by_disease", d, n), plot = p, device = "pdf", width = 5, height = 5)
    ggsave(filename = sprintf("%s/%s/%s/custom_%s.pdf", embedding_fig_dir, "by_network", n, d), plot = p, device = "pdf", width = 3, height = 3)
           
  }
}



#### 
# Rare genetic cardiac disease, all network, custom 3x3

for(d in "Rare genetic cardiac disease"){
  disease = orpha$disgene_list[[d]]
  
  for(n in c("coex/ATC", "coex/HRV","GOBP", "HP", "MP", "ppi")){
    network_name = str_replace(n, "coex/", "")
    
    # load the node2vec embedded results
    tsne_results_df = read_tsv(paste("../cache//embedded_results_2D/", network_name, "tsne.tsv", sep = "_"), col_types = 'ddc') %>% 
      mutate(indisease = name %in% disease)

    n <- str_replace(n, "/", "_") # replace / by _ for labelling
    
    # create directory to store results
    dir.create(file.path(paste0(embedding_fig_dir, "/by_disease"),  d), showWarnings = FALSE)
    dir.create(file.path(paste0(embedding_fig_dir, "/by_network"),  n), showWarnings = FALSE)
 
    
    
    p <- ggplot(tsne_results_df)  + 
      stat_density_2d(aes(X,Y,  fill = stat(level)), geom = "polygon") + 
      theme(panel.background = element_rect(fill = '#0f2030'),
            axis.line=element_blank(),axis.text.x=element_blank(),
            axis.text.y=element_blank(),axis.ticks=element_blank(),
            axis.title.x=element_blank(),
            axis.title.y=element_blank(),legend.position="none",
            panel.border=element_blank(),panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),plot.background=element_blank())+ 
      geom_point(aes(X,Y, alpha = indisease), col = "white", size = 1.5) +
      scale_alpha_discrete(range = c(0, 0.5)) + guides(fill = FALSE, alpha = FALSE, col = FALSE)+
      ggtitle(paste0(d,": ",n))
    
    ggsave(filename = sprintf("%s/%s/%s/custom_%s.pdf", embedding_fig_dir, "by_disease", d, n), plot = p, device = "pdf", width = 3, height = 3)
    #ggsave(filename = sprintf("%s/%s/%s/custom_%s.pdf", embedding_fig_dir, "by_network", n, d), plot = p, device = "pdf", width = 3, height = 3)
           
  }
}

```

```{r}
embed_files_selected <- "HP"

embedplot <- list()

for(d in selected_diseases){
  disease = orpha$disgene_list[[d]]
  
  # create directory to store results
  dir.create(file.path(embedding_fig_dir, d), showWarnings = FALSE)
 
  embedplot[[d]] <- list()
  
  for(n in embed_files_selected){
    network_name = str_replace(n, "coex/", "")
    
    # load the node2vec embedded results
    tsne_results_df = read_tsv(paste("../cache//embedded_results_2D/", network_name, "tsne.tsv", sep = "_"), col_types = 'ddc') %>% 
      mutate(indisease = name %in% disease)

    n <- str_replace(n, "/", "_") # replace / by _ for labelling
    
    embedplot[[d]][[n]] <- ggplot(tsne_results_df)  + 
      stat_density_2d(aes(X,Y,  fill = stat(level)), geom = "polygon") + 
      theme(panel.background = element_rect(fill = '#0f2030'),
            axis.line=element_blank(),axis.text.x=element_blank(),
            axis.text.y=element_blank(),axis.ticks=element_blank(),
            axis.title.x=element_blank(),
            axis.title.y=element_blank(),legend.position="none",
            panel.border=element_blank(),panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),plot.background=element_blank())+ 
      geom_point(aes(X,Y, alpha = indisease), col = "white", size = 1) +
      scale_alpha_discrete(range = c(0, 0.5)) + guides(fill = FALSE, alpha = FALSE, col = FALSE)+
      ggtitle(paste0(d,": ",n))
           
  }
}
```



